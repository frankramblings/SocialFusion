name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Fetch LFS objects
      run: git lfs pull
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Install xcodegen
      run: brew install xcodegen

    - name: Generate Project
      run: xcodegen generate
      
    - name: Build
      run: |
        export IBTOOL_DISABLE_INITIALIZE_WEBVIEW=YES
        xcodebuild -scheme SocialFusion -destination "platform=iOS Simulator,name=iPhone 16 Pro" build -allowProvisioningUpdates -configuration Debug
      
    - name: Run SwiftLint
      run: |
        brew install swiftlint
        swiftlint lint
        
    - name: Run Tests
      run: |
        echo "No test targets configured for this project"
      
    - name: Upload Test Results
      if: always()
      run: echo "No test results to upload"
        
  code-coverage:
    name: Code Coverage
    runs-on: macos-latest
    needs: build-and-test
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Fetch LFS objects
      run: git lfs pull
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
      
    - name: Generate Coverage Report
      run: |
        echo "No test targets configured for coverage generation"
        echo "lcov" > coverage.lcov
        
    - name: Upload Coverage Report
      uses: codecov/codecov-action@v4
      with:
        file: ./coverage.lcov
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

  testflight-deploy:
    name: TestFlight Deployment
    runs-on: macos-latest
    needs: build-and-test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true
    
    - name: Fetch LFS objects
      run: git lfs pull
    
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode.app
    
    - name: Install xcodegen
      run: brew install xcodegen

    - name: Generate Project
      run: xcodegen generate
    
    - name: Setup Apple Developer Credentials
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
        TEAM_ID: ${{ secrets.TEAM_ID }}
      run: |
        # Export TEAM_ID for use in build steps
        echo "TEAM_ID=${{ secrets.TEAM_ID }}" >> $GITHUB_ENV
        
        # Create secure temporary keychain
        KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -t 1800 -u build.keychain  # 30 minutes
        
        # Import certificate with secure handling
        echo "${{ secrets.CERTIFICATE_BASE64 }}" | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "${{ secrets.CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
        
        # Set secure partition list
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
        
        # Create provisioning profile directory
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        
        # Import provisioning profile
        echo "${{ secrets.PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > profile.mobileprovision
        
        # Extract UUID and Name from profile using security tool for robustness
        # First decode the CMS signed data
        security cms -D -i profile.mobileprovision > profile_decoded.plist
        
        UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" profile_decoded.plist)
        PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" profile_decoded.plist)
        
        if [ -n "$UUID" ]; then
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/$UUID.mobileprovision
          echo "Imported profile: $PROFILE_NAME ($UUID)"
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "PROFILE_UUID=$UUID" >> $GITHUB_ENV
        else
          echo "Error: Could not extract UUID from profile"
          exit 1
        fi
        
        # Clean up sensitive files immediately
        rm -f certificate.p12 profile.mobileprovision profile_decoded.plist
    
    - name: Build and Archive
      env:
        IBTOOL_DISABLE_INITIALIZE_WEBVIEW: YES
      run: |
        # Clean build folder
        xcodebuild clean -scheme SocialFusion -configuration Release
        
        # Build and archive with Manual signing and unique build number
        xcodebuild archive \
          -scheme SocialFusion \
          -configuration Release \
          -destination "generic/platform=iOS" \
          -archivePath SocialFusion.xcarchive \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM="${{ secrets.TEAM_ID }}" \
          CODE_SIGN_IDENTITY="Apple Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="$PROFILE_NAME" \
          PRODUCT_BUNDLE_IDENTIFIER="com.emanueledigital.socialfusion" \
          CURRENT_PROJECT_VERSION=$GITHUB_RUN_NUMBER
    
    - name: Export IPA
      run: |
        # Create export options plist for Manual signing
        cat > ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.TEAM_ID }}</string>
            <key>uploadBitcode</key>
            <false/>
            <key>uploadSymbols</key>
            <true/>
            <key>compileBitcode</key>
            <false/>
            <key>signingStyle</key>
            <string>manual</string>
            <key>provisioningProfiles</key>
            <dict>
                <key>com.emanueledigital.socialfusion</key>
                <string>${{ env.PROFILE_NAME }}</string>
            </dict>
        </dict>
        </plist>
        EOF
        
        # Export IPA
        xcodebuild -exportArchive \
          -archivePath SocialFusion.xcarchive \
          -exportPath export \
          -exportOptionsPlist ExportOptions.plist
    
    - name: Upload to TestFlight
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
      run: |
        # Find the IPA file in the export directory
        IPA_PATH=$(find export -name "*.ipa" | head -n 1)
        
        if [ -z "$IPA_PATH" ]; then
          echo "Error: IPA file not found in export directory"
          exit 1
        fi
        
        # Upload to App Store Connect using altool with verbose output
        xcrun altool --upload-app \
          --type ios \
          --file "$IPA_PATH" \
          --username "$APPLE_ID" \
          --password "$APPLE_ID_PASSWORD" \
          --verbose
    
    - name: Cleanup Sensitive Data
      if: always()
      run: |
        # Remove keychain
        security delete-keychain build.keychain 2>/dev/null || true
        
        # Remove provisioning profiles
        rm -rf ~/Library/MobileDevice/Provisioning\ Profiles/* 2>/dev/null || true
        
        # Remove build artifacts
        rm -rf SocialFusion.xcarchive ExportOptions.plist export 2>/dev/null || true
        
        # Clear environment variables
        unset APPLE_ID APPLE_ID_PASSWORD TEAM_ID KEYCHAIN_PASSWORD 
